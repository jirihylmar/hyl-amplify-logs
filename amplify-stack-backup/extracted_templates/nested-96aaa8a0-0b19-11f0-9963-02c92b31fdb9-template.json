"AWSTemplateFormatVersion: '2010-09-09'\nDescription: 'AWS Amplify Logs - Glue Crawler'\n\nParameters:\n  Environment:\n    Type: String\n    Default: inftes\n    AllowedValues:\n      - infdev\n      - inftes\n      - infpro\n    Description: Environment (development, testing, production)\n  \n  AccountNumber:\n    Type: String\n    Default: '182059100462'\n    Description: AWS Account number\n  \n  BucketName:\n    Type: String\n    Default: amplifylogs-logging-intite-ss2-inftes-182059100462\n    Description: S3 bucket containing Amplify logs\n\nResources:\n  GlueCrawlerRole:\n    Type: AWS::IAM::Role\n    Properties:\n      RoleName: !Sub 'amplifylogs-pipeline-intite-ir1-${Environment}-${AccountNumber}-cf'\n      AssumeRolePolicyDocument:\n        Version: '2012-10-17'\n        Statement:\n          - Effect: Allow\n            Principal:\n              Service: glue.amazonaws.com\n            Action: 'sts:AssumeRole'\n      ManagedPolicyArns:\n        - 'arn:aws:iam::aws:policy/service-role/AWSGlueServiceRole'\n      Policies:\n        - PolicyName: S3Access\n          PolicyDocument:\n            Version: '2012-10-17'\n            Statement:\n              - Effect: Allow\n                Action:\n                  - 's3:GetObject'\n                  - 's3:ListBucket'\n                Resource:\n                  - !Sub 'arn:aws:s3:::${BucketName}'\n                  - !Sub 'arn:aws:s3:::${BucketName}/*'\n      Tags:\n        - Key: Project\n          Value: amplifylogs\n        - Key: Owner\n          Value: HylmarJ\n        - Key: CostCenter\n          Value: cc-amplify-001\n        - Key: Environment\n          Value: !Ref Environment\n\n  AmplifyLogsDatabase:\n    Type: AWS::Glue::Database\n    Properties:\n      CatalogId: !Ref AWS::AccountId\n      DatabaseInput:\n        Name: !Sub 'amplifylogs-analysis-intite-gd1-${Environment}-${AccountNumber}'\n        Description: 'Database for Amplify logs analysis'\n\n  AmplifyLogsCrawler:\n    Type: AWS::Glue::Crawler\n    DependsOn: GlueCrawlerRole\n    Properties:\n      Name: !Sub 'amplifylogs-pipeline-intite-gl1-${Environment}-${AccountNumber}'\n      Role: !GetAtt GlueCrawlerRole.Arn\n      DatabaseName: !Ref AmplifyLogsDatabase\n      Targets:\n        S3Targets:\n          - Path: !Sub 's3://${BucketName}/type=amplify_logs/'\n            # Added exclusions to handle case where the bucket might exist but the path doesn't yet\n            Exclusions:\n              - \"**/_temporary/**\"\n      SchemaChangePolicy:\n        UpdateBehavior: 'UPDATE_IN_DATABASE'\n        DeleteBehavior: 'LOG'\n      Configuration: '{\"Version\": 1.0, \"CrawlerOutput\": {\"Partitions\": {\"AddOrUpdateBehavior\": \"InheritFromTable\"}}, \"Grouping\": {\"TableGroupingPolicy\": \"CombineCompatibleSchemas\"}}'\n      RecrawlPolicy:\n        RecrawlBehavior: 'CRAWL_EVERYTHING'\n      # Removing the schedule so it's only triggered by the Lambda\n      Tags:\n        Project: amplifylogs\n        Owner: HylmarJ\n        CostCenter: cc-amplify-001\n        Environment: !Ref Environment\n\nOutputs:\n  DatabaseName:\n    Description: Name of the Glue database\n    Value: !Ref AmplifyLogsDatabase\n  \n  CrawlerName:\n    Description: Name of the Glue crawler\n    Value: !Ref AmplifyLogsCrawler"
