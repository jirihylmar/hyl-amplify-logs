"AWSTemplateFormatVersion: '2010-09-09'\nDescription: 'AWS Amplify Logs - Step Functions Workflow'\n\nParameters:\n  Environment:\n    Type: String\n    Default: inftes\n    AllowedValues:\n      - infdev\n      - inftes\n      - infpro\n    Description: Environment (development, testing, production)\n  \n  AccountNumber:\n    Type: String\n    Default: '182059100462'\n    Description: AWS Account number\n  \n  LogDownloaderLambdaName:\n    Type: String\n    Default: amplifylogs-logging-intite-lm1-inftes-182059100462-cf\n    Description: Name of the Log Downloader Lambda function\n  \n  CrawlerTriggerLambdaName:\n    Type: String\n    Default: amplifylogs-pipeline-intite-lm1-inftes-182059100462-cf\n    Description: Name of the Crawler Trigger Lambda function\n  \n  CalculateTimeRangesLambdaName:\n    Type: String\n    Default: amplifylogs-orchestration-intite-lm2-inftes-182059100462-cf\n    Description: Name of the Calculate Time Ranges Lambda function\n\nResources:\n  AmplifyLogsStateMachineRole:\n    Type: AWS::IAM::Role\n    Properties:\n      RoleName: !Sub 'amplifylogs-orchestration-intite-ir1-${Environment}-${AccountNumber}-cf'\n      AssumeRolePolicyDocument:\n        Version: '2012-10-17'\n        Statement:\n          - Effect: Allow\n            Principal:\n              Service: states.amazonaws.com\n            Action: 'sts:AssumeRole'\n      ManagedPolicyArns:\n        - 'arn:aws:iam::aws:policy/service-role/AWSLambdaRole'\n      Tags:\n        - Key: Project\n          Value: amplifylogs\n        - Key: Owner\n          Value: HylmarJ\n        - Key: CostCenter\n          Value: cc-amplify-001\n        - Key: Environment\n          Value: !Ref Environment\n\n  AmplifyLogsStateMachine:\n    Type: AWS::StepFunctions::StateMachine\n    Properties:\n      StateMachineName: !Sub 'amplifylogs-orchestration-intite-sf1-${Environment}-${AccountNumber}-cf'\n      RoleArn: !GetAtt AmplifyLogsStateMachineRole.Arn\n      Definition:\n        Comment: \"AWS Amplify Logs Workflow\"\n        StartAt: \"CalculateTimeRanges\"\n        States:\n          CalculateTimeRanges:\n            Type: \"Task\"\n            Resource: !Sub 'arn:aws:lambda:${AWS::Region}:${AccountNumber}:function:${CalculateTimeRangesLambdaName}'\n            Comment: \"Calculate time ranges based on chunk size\"\n            ResultPath: \"$.timeRanges\"\n            Retry:\n              - ErrorEquals: [\"States.ALL\"]\n                IntervalSeconds: 1\n                MaxAttempts: 3\n                BackoffRate: 2\n            Catch:\n              - ErrorEquals: [\"States.ALL\"]\n                ResultPath: \"$.error\"\n                Next: \"WorkflowFailed\"\n            Next: \"ProcessApplications\"\n          ProcessApplications:\n            Type: \"Map\"\n            Comment: \"Process each application\"\n            ItemsPath: \"$.config.applications\"\n            Parameters:\n              app.$: \"$$.Map.Item.Value\"\n              s3.$: \"$.config.s3\"\n              timeRanges.$: \"$.timeRanges\"\n            Iterator:\n              StartAt: \"ProcessTimeChunks\"\n              States:\n                ProcessTimeChunks:\n                  Type: \"Map\"\n                  Comment: \"Process each time chunk for this application\"\n                  ItemsPath: \"$.timeRanges\"\n                  Parameters:\n                    app.$: \"$.app\"\n                    s3.$: \"$.s3\"\n                    timeRange.$: \"$$.Map.Item.Value\"\n                  Iterator:\n                    StartAt: \"DownloadLogs\"\n                    States:\n                      DownloadLogs:\n                        Type: \"Task\"\n                        Resource: !Sub 'arn:aws:lambda:${AWS::Region}:${AccountNumber}:function:${LogDownloaderLambdaName}'\n                        Comment: \"Download logs for this app and time range\"\n                        Retry:\n                          - ErrorEquals: [\"States.TaskFailed\"]\n                            IntervalSeconds: 60\n                            MaxAttempts: 3\n                            BackoffRate: 2\n                        Catch:\n                          - ErrorEquals: [\"States.ALL\"]\n                            ResultPath: \"$.error\"\n                            Next: \"ChunkFailed\"\n                        End: true\n                      ChunkFailed:\n                        Type: \"Pass\"\n                        Comment: \"Record failure for this chunk\"\n                        End: true\n                  End: true\n            ResultPath: \"$.processResults\"\n            Next: \"TriggerCrawler\"\n          TriggerCrawler:\n            Type: \"Task\"\n            Resource: !Sub 'arn:aws:lambda:${AWS::Region}:${AccountNumber}:function:${CrawlerTriggerLambdaName}'\n            Comment: \"Trigger Glue Crawler after all downloads are complete\"\n            Retry:\n              - ErrorEquals: [\"States.ALL\"]\n                IntervalSeconds: 60\n                MaxAttempts: 3\n                BackoffRate: 2\n            Catch:\n              - ErrorEquals: [\"States.ALL\"]\n                ResultPath: \"$.error\"\n                Next: \"WorkflowFailed\"\n            Next: \"WorkflowSucceeded\"\n          WorkflowSucceeded:\n            Type: \"Succeed\"\n          WorkflowFailed:\n            Type: \"Fail\"\n            Error: \"WorkflowFailed\"\n            Cause: \"One or more steps failed. Check the execution details.\"\n      Tags:\n        - Key: Project\n          Value: amplifylogs\n        - Key: Owner\n          Value: HylmarJ\n        - Key: CostCenter\n          Value: cc-amplify-001\n        - Key: Environment\n          Value: !Ref Environment\n\n  # Instead of creating an EventBridge rule directly, we're just going to output\n  # the StateMachine ARN, then we can create the rule manually or in a separate template\n\nOutputs:\n  StateMachineArn:\n    Description: ARN of the Step Functions State Machine\n    Value: !Ref AmplifyLogsStateMachine"
