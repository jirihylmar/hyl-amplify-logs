"AWSTemplateFormatVersion: '2010-09-09'\nDescription: 'AWS Amplify Logs - S3 Storage'\n\nParameters:\n  Environment:\n    Type: String\n    Default: inftes\n    AllowedValues:\n      - infdev\n      - inftes\n      - infpro\n    Description: Environment (development, testing, production)\n  \n  AccountNumber:\n    Type: String\n    Default: '182059100462'\n    Description: AWS Account number\n  \n  LogRetentionDays:\n    Type: Number\n    Default: 365\n    Description: Number of days to retain logs\n\n  # Add parameter to control bucket creation\n  CreateNewBucket:\n    Type: String\n    Default: 'false'\n    AllowedValues:\n      - 'true'\n      - 'false'\n    Description: Whether to create a new S3 bucket or use existing bucket\n\nConditions:\n  ShouldCreateBucket: !Equals [!Ref CreateNewBucket, 'true']\n\nResources:\n  AmplifyLogsBucket:\n    Type: AWS::S3::Bucket\n    Condition: ShouldCreateBucket\n    Properties:\n      BucketName: !Sub 'amplifylogs-logging-intite-ss2-${Environment}-${AccountNumber}'\n      VersioningConfiguration:\n        Status: Enabled\n      LifecycleConfiguration:\n        Rules:\n          - Id: LogRetention\n            Status: Enabled\n            ExpirationInDays: !Ref LogRetentionDays\n            Prefix: 'type=amplify_logs/'\n      BucketEncryption:\n        ServerSideEncryptionConfiguration:\n          - ServerSideEncryptionByDefault:\n              SSEAlgorithm: AES256\n      Tags:\n        - Key: Project\n          Value: amplifylogs\n        - Key: Owner\n          Value: HylmarJ\n        - Key: CostCenter\n          Value: cc-amplify-001\n        - Key: Environment\n          Value: !Ref Environment\n\n  AmplifyLogsBucketPolicy:\n    Type: AWS::S3::BucketPolicy\n    Condition: ShouldCreateBucket\n    Properties:\n      Bucket: !Ref AmplifyLogsBucket\n      PolicyDocument:\n        Version: '2012-10-17'\n        Statement:\n          - Sid: DenyUnencryptedObjectUploads\n            Effect: Deny\n            Principal: '*'\n            Action: 's3:PutObject'\n            Resource: !Sub '${AmplifyLogsBucket.Arn}/*'\n            Condition:\n              StringNotEquals:\n                's3:x-amz-server-side-encryption': 'AES256'\n          - Sid: DenyInsecureConnections\n            Effect: Deny\n            Principal: '*'\n            Action: 's3:*'\n            Resource: !Sub '${AmplifyLogsBucket.Arn}/*'\n            Condition:\n              Bool:\n                'aws:SecureTransport': 'false'\n\nOutputs:\n  BucketName:\n    Description: Name of the S3 bucket for Amplify logs\n    Value: !If \n      - ShouldCreateBucket\n      - !Ref AmplifyLogsBucket\n      - !Sub 'amplifylogs-logging-intite-ss2-${Environment}-${AccountNumber}'\n  \n  BucketArn:\n    Description: ARN of the S3 bucket\n    Value: !If \n      - ShouldCreateBucket\n      - !GetAtt AmplifyLogsBucket.Arn\n      - !Sub 'arn:aws:s3:::amplifylogs-logging-intite-ss2-${Environment}-${AccountNumber}'"
