"AWSTemplateFormatVersion: '2010-09-09'\nDescription: 'AWS Amplify Logs - Complete Infrastructure'\n\nParameters:\n  Environment:\n    Type: String\n    Default: inftes\n    AllowedValues:\n      - infdev\n      - inftes\n      - infpro\n    Description: Environment (development, testing, production)\n  \n  AccountNumber:\n    Type: String\n    Default: '182059100462'\n    Description: AWS Account number\n  \n  LogRetentionDays:\n    Type: Number\n    Default: 365\n    Description: Number of days to retain logs\n    \n  # Parameter to control bucket creation\n  CreateNewS3Bucket:\n    Type: String\n    Default: 'false'\n    AllowedValues:\n      - 'true'\n      - 'false'\n    Description: Whether to create a new S3 bucket or use an existing one\n\nResources:\n  # S3 Storage\n  S3Resources:\n    Type: AWS::CloudFormation::Stack\n    Properties:\n      TemplateURL: 'https://amplifylogs-deployment-182059100462.s3.amazonaws.com/cloudformation/s3.yaml'\n      Parameters:\n        Environment: !Ref Environment\n        AccountNumber: !Ref AccountNumber\n        LogRetentionDays: !Ref LogRetentionDays\n        CreateNewBucket: !Ref CreateNewS3Bucket\n      Tags:\n        - Key: Project\n          Value: amplifylogs\n        - Key: Owner\n          Value: HylmarJ\n        - Key: CostCenter\n          Value: cc-amplify-001\n        - Key: Environment\n          Value: !Ref Environment\n\n  # Lambda IAM Roles - Make names unique with suffixes\n  LogDownloaderRole:\n    Type: AWS::IAM::Role\n    Properties:\n      RoleName: !Sub 'amplifylogs-logging-intite-ir1-${Environment}-${AccountNumber}-cf'\n      AssumeRolePolicyDocument:\n        Version: '2012-10-17'\n        Statement:\n          - Effect: Allow\n            Principal:\n              Service: lambda.amazonaws.com\n            Action: 'sts:AssumeRole'\n      ManagedPolicyArns:\n        - 'arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole'\n      Policies:\n        - PolicyName: AmplifyAccess\n          PolicyDocument:\n            Version: '2012-10-17'\n            Statement:\n              - Effect: Allow\n                Action:\n                  - 'amplify:GenerateAccessLogs'\n                Resource: '*'\n        - PolicyName: S3Access\n          PolicyDocument:\n            Version: '2012-10-17'\n            Statement:\n              - Effect: Allow\n                Action:\n                  - 's3:PutObject'\n                  - 's3:GetObject'\n                  - 's3:ListBucket'\n                Resource:\n                  - !GetAtt S3Resources.Outputs.BucketArn\n                  - !Sub '${S3Resources.Outputs.BucketArn}/*'\n      Tags:\n        - Key: Project\n          Value: amplifylogs\n        - Key: Owner\n          Value: HylmarJ\n        - Key: CostCenter\n          Value: cc-amplify-001\n        - Key: Environment\n          Value: !Ref Environment\n\n  CrawlerTriggerRole:\n    Type: AWS::IAM::Role\n    Properties:\n      RoleName: !Sub 'amplifylogs-pipeline-intite-ir2-${Environment}-${AccountNumber}-cf'\n      AssumeRolePolicyDocument:\n        Version: '2012-10-17'\n        Statement:\n          - Effect: Allow\n            Principal:\n              Service: lambda.amazonaws.com\n            Action: 'sts:AssumeRole'\n      ManagedPolicyArns:\n        - 'arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole'\n      Policies:\n        - PolicyName: GlueAccess\n          PolicyDocument:\n            Version: '2012-10-17'\n            Statement:\n              - Effect: Allow\n                Action:\n                  - 'glue:StartCrawler'\n                  - 'glue:GetCrawler'\n                Resource: '*'\n      Tags:\n        - Key: Project\n          Value: amplifylogs\n        - Key: Owner\n          Value: HylmarJ\n        - Key: CostCenter\n          Value: cc-amplify-001\n        - Key: Environment\n          Value: !Ref Environment\n\n  CalculateTimeRangesRole:\n    Type: AWS::IAM::Role\n    Properties:\n      RoleName: !Sub 'amplifylogs-orchestration-intite-ir3-${Environment}-${AccountNumber}-cf'\n      AssumeRolePolicyDocument:\n        Version: '2012-10-17'\n        Statement:\n          - Effect: Allow\n            Principal:\n              Service: lambda.amazonaws.com\n            Action: 'sts:AssumeRole'\n      ManagedPolicyArns:\n        - 'arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole'\n      Tags:\n        - Key: Project\n          Value: amplifylogs\n        - Key: Owner\n          Value: HylmarJ\n        - Key: CostCenter\n          Value: cc-amplify-001\n        - Key: Environment\n          Value: !Ref Environment\n\n  # Lambda Functions\n  LogDownloaderLambda:\n    Type: AWS::Lambda::Function\n    DependsOn: S3Resources\n    Properties:\n      FunctionName: !Sub 'amplifylogs-logging-intite-lm1-${Environment}-${AccountNumber}-cf'\n      Handler: lambda_function.lambda_handler\n      Role: !GetAtt LogDownloaderRole.Arn\n      Code:\n        S3Bucket: !Sub 'amplifylogs-deployment-${AccountNumber}'\n        S3Key: 'lambda/log_downloader_lambda.zip'\n      Runtime: python3.9\n      Timeout: 900\n      MemorySize: 1024\n      Tags:\n        - Key: Project\n          Value: amplifylogs\n        - Key: Owner\n          Value: HylmarJ\n        - Key: CostCenter\n          Value: cc-amplify-001\n        - Key: Environment\n          Value: !Ref Environment\n\n  # Glue Resources - Must come after S3 is created\n  GlueResources:\n    Type: AWS::CloudFormation::Stack\n    DependsOn: S3Resources\n    Properties:\n      TemplateURL: 'https://amplifylogs-deployment-182059100462.s3.amazonaws.com/cloudformation/crawler.yaml'\n      Parameters:\n        Environment: !Ref Environment\n        AccountNumber: !Ref AccountNumber\n        BucketName: !GetAtt S3Resources.Outputs.BucketName\n      Tags:\n        - Key: Project\n          Value: amplifylogs\n        - Key: Owner\n          Value: HylmarJ\n        - Key: CostCenter\n          Value: cc-amplify-001\n        - Key: Environment\n          Value: !Ref Environment\n\n  CrawlerTriggerLambda:\n    Type: AWS::Lambda::Function\n    DependsOn: GlueResources\n    Properties:\n      FunctionName: !Sub 'amplifylogs-pipeline-intite-lm1-${Environment}-${AccountNumber}-cf'\n      Handler: lambda_function.lambda_handler\n      Role: !GetAtt CrawlerTriggerRole.Arn\n      Code:\n        S3Bucket: !Sub 'amplifylogs-deployment-${AccountNumber}'\n        S3Key: 'lambda/crawler_trigger_lambda.zip'\n      Runtime: python3.9\n      Timeout: 60\n      MemorySize: 128\n      Environment:\n        Variables:\n          CRAWLER_NAME: !GetAtt GlueResources.Outputs.CrawlerName\n      Tags:\n        - Key: Project\n          Value: amplifylogs\n        - Key: Owner\n          Value: HylmarJ\n        - Key: CostCenter\n          Value: cc-amplify-001\n        - Key: Environment\n          Value: !Ref Environment\n\n  CalculateTimeRangesLambda:\n    Type: AWS::Lambda::Function\n    Properties:\n      FunctionName: !Sub 'amplifylogs-orchestration-intite-lm2-${Environment}-${AccountNumber}-cf'\n      Handler: lambda_function.lambda_handler\n      Role: !GetAtt CalculateTimeRangesRole.Arn\n      Code:\n        S3Bucket: !Sub 'amplifylogs-deployment-${AccountNumber}'\n        S3Key: 'lambda/calculate_time_ranges_lambda.zip'\n      Runtime: python3.9\n      Timeout: 60\n      MemorySize: 128\n      Tags:\n        - Key: Project\n          Value: amplifylogs\n        - Key: Owner\n          Value: HylmarJ\n        - Key: CostCenter\n          Value: cc-amplify-001\n        - Key: Environment\n          Value: !Ref Environment\n\n  # Step Functions\n  StepFunctionsResources:\n    Type: AWS::CloudFormation::Stack\n    DependsOn: \n      - LogDownloaderLambda\n      - CrawlerTriggerLambda\n      - CalculateTimeRangesLambda\n      - GlueResources\n    Properties:\n      TemplateURL: 'https://amplifylogs-deployment-182059100462.s3.amazonaws.com/cloudformation/step-functions.yaml'\n      Parameters:\n        Environment: !Ref Environment\n        AccountNumber: !Ref AccountNumber\n        LogDownloaderLambdaName: !Ref LogDownloaderLambda\n        CrawlerTriggerLambdaName: !Ref CrawlerTriggerLambda\n        CalculateTimeRangesLambdaName: !Ref CalculateTimeRangesLambda\n      Tags:\n        - Key: Project\n          Value: amplifylogs\n        - Key: Owner\n          Value: HylmarJ\n        - Key: CostCenter\n          Value: cc-amplify-001\n        - Key: Environment\n          Value: !Ref Environment\n\nOutputs:\n  BucketName:\n    Description: S3 Bucket for Amplify logs\n    Value: !GetAtt S3Resources.Outputs.BucketName\n  \n  DatabaseName:\n    Description: Glue Database name\n    Value: !GetAtt GlueResources.Outputs.DatabaseName\n  \n  CrawlerName:\n    Description: Glue Crawler name\n    Value: !GetAtt GlueResources.Outputs.CrawlerName\n  \n  StateMachineArn:\n    Description: Step Functions State Machine ARN\n    Value: !GetAtt StepFunctionsResources.Outputs.StateMachineArn"
